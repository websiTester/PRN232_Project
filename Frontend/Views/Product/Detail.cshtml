@model ProductDetailDto
@section Styles {
    <link rel="stylesheet" href="~/css/product-detail.css" asp-append-version="true" />
}
@{
    ViewData["Title"] = Model.Title ?? "Product Detail";
    var sortedRatings = Model.RatingCounts.OrderByDescending(kv => kv.Key);
}

<div class="container product-detail-container">
    <div class="row">
        <div class="col-md-5">
            <img src="@Model.Images" alt="@Model.Title" class="img-fluid product-detail-image" />
        </div>

        <div class="col-md-7">
            <h1 class="product-detail-title">@Model.Title</h1>

            <div class="product-detail-seller">
                <span>Sold by: </span>
                <a href="#">@Model.SellerName</a> |
                <span>Category: </span>
                <a href="#">@Model.CategoryName</a>
                @* Chat with seller button *@
                @if (Model.SellerId != null)
                {
                    <span> | </span>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="chat-with-seller" data-seller-id="@Model.SellerId" data-seller-name="@Model.SellerName">Chat with seller</button>
                }
                
            </div>

            <hr />

            <div class="product-detail-quick-rating">
                <span class="star-display">
                    @Model.AverageRating.ToString("F1") ★
                </span>
                <a href="#ratings-reviews" class="ms-2">@Model.ReviewCount ratings</a>
            </div>

            <div class="product-detail-price">
                US $@Model.Price?.ToString("#,##0.00")
            </div>

            <form asp-controller="Product" asp-action="Buy" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-buy-now">Buy It Now</button>
                <button type="button" class="btn btn-add-cart">Add to cart</button>
                <button type="button" class="btn btn-watch-list">Add to Watchlist</button>
            </form>
        </div>
    </div>

    <hr class="mt-5 mb-4" />

    <div class="row" id="ratings-reviews">
        <div class="col-12">
            <h2>Product ratings and reviews</h2>
        </div>

        <div class="col-md-4">
            <div class="rating-summary">
                <div class="rating-score">@Model.AverageRating.ToString("F1")</div>

                <div class="star-display-large">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= Math.Round(Model.AverageRating))
                        {
                            <span style="color: #f57f17;">★</span>
                        }
                        else
                        {
                            <span style="color: #ccc;">☆</span>
                        }
                    }
                </div>

                <div>Based on @Model.ReviewCount ratings</div>
            </div>

            <div class="rating-bars">
                @foreach (var rating in sortedRatings)
                {
                    <div class="rating-bar-row">
                        <span class="rating-bar-label">@rating.Key stars</span>
                        <div class="progress">
                            @{
                                var percentage = (Model.ReviewCount > 0) ? (rating.Value * 100.0 / Model.ReviewCount) : 0;
                            }
                            <div class="progress-bar" role="progressbar" style="width: @percentage%;" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <span class="rating-bar-count">@rating.Value</span>
                    </div>
                }
            </div>
        </div>

        <div class="col-md-8">
            <h3>Most relevant reviews</h3>

            @if (!Model.Reviews.Any())
            {
                <div class="review-card">
                    <p>Be the first to review this item.</p>
                </div>
            }

            @foreach (var review in Model.Reviews)
            {
                <div class="review-card">
                    <div class="review-header">
                        <span class="star-display">
                            @for (int i = 0; i < review.Rating; i++)
                            {
                                <span>★</span>
                            }
                            @for (int i = review.Rating; i < 5; i++)
                            {
                                <span class="star-empty">☆</span>
                            }
                        </span>
                    </div>
                    <h4 class="review-comment">@review.Comment</h4>
                    <div class="review-footer">
                        by @review.ReviewerUsername on @review.CreatedAt.ToShortDateString()
                        <span class="review-verified">| Verified purchase</span>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
<script>
    (function(){
        var btn = document.getElementById('chat-with-seller');
        if(!btn) return;
        btn.addEventListener('click', function(){
            var id = btn.getAttribute('data-seller-id');
            var name = btn.getAttribute('data-seller-name');
            try{
                if(window.openChatWith){
                    window.openChatWith(id, name);
                } else {
                    // fallback: ensure chat toggle visible and set session data for later
                    localStorage.setItem('chat_target_user', JSON.stringify({ id: id, name: name }));
                    var toggle = document.getElementById('chat-toggle-btn'); if(toggle) toggle.click();
                }
            }catch(e){ console.error('open chat error', e); }
        });
    })();
</script>