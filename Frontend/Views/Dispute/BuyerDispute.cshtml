@using Azure.Core
@model List<Backend.DTOs.Dispute.DisputeListItemDto>
@{
    int buyerId = (int)ViewBag.buyerId;
    int? currentStatus = ViewBag.StatusFilter as int?;
    string currentTime = ViewBag.TimeFilter as string ?? "all";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khiếu nại Đã Gửi Của Bạn</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải icon (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
        font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">



    <!-- Nội dung chính -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Vùng nội dung -->
        <div class="bg-white p-6 rounded-lg shadow-sm">

            <!-- Bộ lọc -->
            <div class="gap-4 mb-6">
                <!-- hoặc chỉ bg-white, p-6... -->
                <form method="get"
                class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

                    <!-- giữ lại buyerId khi submit -->
                    <input type="hidden" name="buyerId" value="@buyerId" />

                    <!-- Trạng thái -->
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select id="filter-status" name="statusFilter"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                            <!-- Tất cả -->
                            <option value=""
                            selected="@(currentStatus == null ? "selected" : null)">
                                Tất cả trạng thái
                            </option>

                            <!-- Chưa phản hồi: status 1 & 3 -->
                            <option value="1"
                            selected="@(currentStatus == 1 ? "selected" : null)">
                                Chưa phản hồi
                            </option>

                            <!-- Đã phản hồi: status 2 & 4 -->
                            <option value="2"
                            selected="@(currentStatus == 2 ? "selected" : null)">
                                Đã phản hồi
                            </option>
                        </select>
                    </div>

                    <!-- Khoảng thời gian -->
                    <div>
                        <label for="filter-time" class="block text-sm font-medium text-gray-700 mb-1">Khoảng thời gian</label>
                        <select id="filter-time" name="timeFilter"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                            <option value="30"
                            selected="@(currentTime == "30" ? "selected" : null)">
                                30 ngày qua
                            </option>

                            <option value="60"
                            selected="@(currentTime == "60" ? "selected" : null)">
                                60 ngày qua
                            </option>

                            <option value="all"
                            selected="@(currentTime == "all" ? "selected" : null)">
                                Tất cả
                            </option>
                        </select>
                    </div>

                    <!-- Nút Lọc -->
                    <div class="flex justify-start md:justify-end">
                        <button type="submit"
                        class="w-full md:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <ion-icon name="filter-outline" class="mr-2"></ion-icon>
                            Lọc kết quả
                        </button>
                    </div>
                </form>


            </div>

            <!-- ===== Nội dung Khiếu nại Đã Gửi (BUYER) ===== -->
            <div>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                    <h2 class="text-lg font-semibold text-gray-800">
                        Danh sách khiếu nại đã gửi (@(Model?.Count ?? 0))
                    </h2>
                </div>

                <!-- Danh sách khiếu nại -->
                <div class="space-y-4">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            // Lấy sản phẩm đầu tiên để hiển thị chính
                            var firstProduct = item.Products?.FirstOrDefault();
                            var productTitle = firstProduct?.ProductTitle ?? "Sản phẩm";
                            var sellerName = firstProduct?.SellerName ?? item.SellerName ?? "Không rõ";

                            var otherCount = (item.Products?.Count ?? 0) - 1;
                            var extraText = otherCount > 0
                            ? $" + {otherCount} sản phẩm khác"
                            : string.Empty;

                            var submittedDate = item.SubmittedDate?.ToString("dd/MM/yyyy") ?? "-";
                            var code = item.SubmittedDate?.ToString("yyyyMMdd") ?? "12543645";
                            // Dùng Description làm "loại khiếu nại" nếu bạn chưa tách riêng field
                            var mainReason = item.MainReason switch
                            {
                                "not-described" => "Sản phẩm không đúng như mô tả",
                                "not-received" => "Tôi không nhận được hàng",
                                // fallback khi null, rỗng hoặc giá trị khác 2 loại trên
                                null or "" => "Khiếu nại",
                                _ => "Khiếu nại"
                            };
                            var detailReason = item.DetailReason switch
                            {
                                "damaged" => "Sản phẩm bị hỏng, vỡ",
                                "wrong-item" => "Gửi sai sản phẩm",
                                "missing-parts" => "Sản phẩm thiếu bộ phận/phụ kiện",
                                "fake" => "Hàng giả",
                                "different" => "Không giống ảnh/mô tả",
                                null or "" => "Khiếu nại",
                                _ => "Khiếu nại"
                            };
                            var resolutionRequest = item.ResolutionRequest switch
                            {
                                "refund" => "Hoàn tiền 100%",
                                "partial-refund" => "Hoàn tiền một phần",
                                "replace" => "Gửi hàng thay thế",
                                null or "" => "Khiếu nại",
                                _ => "Khiếu nại"
                            };
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 transition hover:shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                                    <!-- Sản phẩm -->
                                    <div class="md:col-span-2 flex items-center space-x-3">
                                        <img src="https://placehold.co/80x80/e2e8f0/adb5bd?text=Hinh+SP"
                                        alt="Hình ảnh sản phẩm"
                                        class="w-16 h-16 rounded-md object-cover border" />
                                        <div>
                                            <p class="font-medium text-gray-900">
                                                @productTitle@if (!string.IsNullOrEmpty(extraText))
                                                {
                                                    <span class="text-sm text-gray-500">@extraText</span>
                                                }
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Mã ĐH: #@code@item.OrderId
                                            </p>
                                            
                                        </div>
                                    </div>

                                    <!-- Đối tác (Người bán) -->
                                    <div>
                                        <p class="text-xs text-gray-500">Người bán</p>
                                        <p class="font-medium text-gray-800">
                                            @sellerName
                                        </p>
                                    </div>

                                    <!-- Loại -->
                                    <div>
                                        <p class="text-xs text-gray-500">Loại</p>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            @mainReason
                                        </span>
                                    </div>

                                    <!-- Trạng thái & Ngày -->
                                    <div>
                                        <p class="text-xs text-gray-500">Trạng thái</p>
                                        @if(item.Status.Equals("1") || item.Status.Equals("3"))
                                        {
                                            <p class="font-semibold text-yellow-600">
                                                Chưa phản hồi
                                            </p>
                                        }
                                        else if (item.Status.Equals("2") || item.Status.Equals("4"))
                                        {
                                            <p class="font-semibold text-green-600">
                                                Đã phản hồi
                                            </p>
                                        }

                                        <p class="text-xs text-gray-500 mt-1">
                                            Ngày gửi: @submittedDate
                                        </p>
                                    </div>

                                    <!-- Hành động -->
                                    <div class="md:text-right">
                                        <!-- Nút mở popup -->
                                        <button type="button"
                                                class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700"
                                                onclick="openDisputeModal(this)"
                                                data-order="#@code@item.OrderId"
                                                data-mainreason="@mainReason"
                                                data-resolution="@resolutionRequest"
                                                data-detailreason="@detailReason"
                                                data-usercontent="@item.UserContent"
                                                data-status="@item.Status"
                                                data-response-resolution="@(item.Resolution ?? "Chưa có phản hồi")"
                                                data-response-comment="@(item.Comment ?? "Chưa có phản hồi")">
                                            Xem chi tiết
                                        </button>

                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-sm text-gray-500">Bạn chưa có khiếu nại nào.</p>
                    }
                </div>
            </div>
            <!-- Modal chi tiết khiếu nại -->
            <div id="disputeModal"
                 class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[9999] p-4"
                 role="dialog" aria-modal="true" aria-labelledby="disputeModalTitle">
                <!-- Nội dung modal -->
                <div class="modal-content bg-white rounded-xl shadow-2xl max-w-3xl w-full overflow-hidden">

                    <!-- Body Modal -->
                    <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">

                        <!-- Lưới thông tin chung -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                            
                            <div class="info-item col-span-1 md:col-span-2">
                                <span class="font-medium text-gray-500 block mb-1">Mã đơn hàng:</span>
                                <span id="modal-order" class="text-gray-900"></span>
                            </div>
                            <!-- LÝ DO CHÍNH (đặt ở lưới thông tin chung, như yêu cầu) -->
                            <div class="info-item">
                                <span class="font-medium text-gray-500 block mb-1">Lý do chính:</span>
                                <span id="modal-mainreason" class="text-gray-900 font-semibold text-red-600"></span>
                            </div>

                            <div class="info-item">
                                <span class="font-medium text-gray-500 block mb-1">Yêu cầu giải quyết:</span>
                                <span id="modal-resolution" class="text-gray-900 font-bold text-blue-600"></span>
                            </div>

                            <div class="info-item">
                                <span class="font-medium text-gray-500 block mb-1">Trạng thái:</span>
                                <span id="modal-status"
                                      class="inline-block px-3 py-1 text-xs font-medium rounded-full border"></span>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Các "ô" chi tiết -->
                        <div class="space-y-4">
                            <!-- Ô Chi tiết lý do (tích hợp "Nội dung từ bạn") -->
                            <div class="detail-box bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <p class="font-semibold text-gray-700 mb-2">Chi tiết lý do</p>
                                <p id="modal-detailreason" class="text-gray-800 whitespace-pre-line text-sm"></p>

                                <p class="font-semibold text-gray-700 mb-2 mt-3 pt-3 border-t border-gray-200">
                                    Nội dung bổ sung
                                </p>
                                <p id="modal-usercontent" class="text-gray-800 whitespace-pre-line text-sm"></p>
                            </div>

                            <!-- Ô Phản hồi từ người bán (nếu có) -->
                            <div class="detail-box bg-green-50 border border-green-200 rounded-lg p-4">
                                <p class="font-semibold text-green-800 mb-2">Phản hồi từ người bán</p>
                                <p id="modal-seller-response-type" class="text-green-900 text-sm font-medium"></p>

                                <p class="font-semibold text-green-800 mb-2 mt-3 pt-3 border-t border-green-100">
                                    Chi tiết phản hồi
                                </p>
                                <p id="modal-seller-response-detail" class="text-green-900 whitespace-pre-line text-sm"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Modal -->
                    <div class="flex items-center justify-end p-5 border-t border-gray-200 space-x-3">
                        <button type="button"
                                class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-300 transition-all"
                                onclick="closeDisputeModal()">
                            Đóng
                        </button>
                    </div>
                </div>
            </div>


            <script>
                function openDisputeModal(btn) {
                    const modal = document.getElementById("disputeModal");

                    // Lấy dữ liệu từ nút
                    const data = {
                        order: btn.getAttribute("data-order") || "",
                        mainReason: btn.getAttribute("data-mainreason") || "",
                        resolution: btn.getAttribute("data-resolution") || "",
                        detailReason: btn.getAttribute("data-detailreason") || "",
                        userContent: btn.getAttribute("data-usercontent") || "",
                        status: (btn.getAttribute("data-status") || "").toString().trim(),
                        responseResolution: btn.getAttribute("data-response-resolution") || "",
                        responseComment: btn.getAttribute("data-response-comment") || ""
                    };

                    // ----- Mapping TRỰC TIẾP (không dùng function) -----

                    // Badge trạng thái: text + class
                    // Nếu bạn muốn hiển thị đúng raw status (1/2/3/4) thì dùng statusText = data.status;
                    // Còn dưới đây là map nhanh trong hàm:
                    const statusMap = {
                        "1": { text: "Chưa phản hồi", cls: "border-red-300 bg-red-50 text-red-700" },
                        "2": { text: "Đã phản hồi",    cls: "border-yellow-300 bg-yellow-50 text-yellow-700" },
                        "3": { text: "Chưa phản hồi",          cls: "border-orange-300 bg-orange-50 text-orange-700" },
                        "4": { text: "Đã phản hồi",                cls: "border-green-300 bg-green-50 text-green-700" }
                    };
                    const status = statusMap[data.status] || { text: (data.status || "Không rõ"), cls: "border-gray-300 bg-gray-50 text-gray-700" };

                    // Lý do chính: nếu không cần map ra tiếng Việt, hiển thị raw; nếu trống thì "Khiếu nại"
                    const mainReasonLabel = data.mainReason || "Khiếu nại";

                    // ----- Đổ dữ liệu vào modal -----
                    document.getElementById("modal-order").textContent = data.order;
                    document.getElementById("modal-mainreason").textContent = mainReasonLabel;
                    document.getElementById("modal-resolution").textContent = data.resolution;

                    const statusEl = document.getElementById("modal-status");
                    statusEl.textContent = status.text;
                    statusEl.className = "inline-block px-3 py-1 text-xs font-medium rounded-full border " + status.cls;

                    document.getElementById("modal-detailreason").textContent = data.detailReason || "—";
                    document.getElementById("modal-usercontent").textContent  = data.userContent  || "—";

                    document.getElementById("modal-seller-response-type").textContent   = data.responseResolution || "Chưa có phản hồi";
                    document.getElementById("modal-seller-response-detail").textContent = data.responseComment   || "Chưa có phản hồi";

                    // Hiển thị modal
                    modal.classList.remove("hidden");
                    modal.classList.add("flex");
                }

                function closeDisputeModal() {
                    const modal = document.getElementById("disputeModal");
                    modal.classList.add("hidden");
                    modal.classList.remove("flex");
                }

                // Đóng bằng ESC & click overlay
                window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeDisputeModal(); });
                document.getElementById("disputeModal").addEventListener("click", (e) => {
                    if (e.target.id === "disputeModal") closeDisputeModal();
                });
            </script>


        </div>
    </main>

</body>
</html>