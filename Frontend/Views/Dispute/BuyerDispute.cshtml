@using Azure.Core
@model List<Backend.DTOs.Dispute.DisputeListItemDto>
@{
    int buyerId = (int)ViewBag.buyerId;
    int? currentStatus = ViewBag.StatusFilter as int?;
    string currentTime = ViewBag.TimeFilter as string ?? "all";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khiếu nại Đã Gửi Của Bạn</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải icon (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
        font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    

    <!-- Nội dung chính -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Vùng nội dung -->
        <div class="bg-white p-6 rounded-lg shadow-sm">

            <!-- Bộ lọc -->
            <div class="gap-4 mb-6">
                <!-- hoặc chỉ bg-white, p-6... -->
                <form method="get"
                      class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

                    <!-- giữ lại buyerId khi submit -->
                    <input type="hidden" name="buyerId" value="@buyerId" />

                    <!-- Trạng thái -->
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select id="filter-status" name="statusFilter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                            <!-- Tất cả -->
                            <option value=""
                                    selected="@(currentStatus == null ? "selected" : null)">
                                Tất cả trạng thái
                            </option>

                            <!-- Chưa phản hồi: status 1 & 3 -->
                            <option value="1"
                                    selected="@(currentStatus == 1 ? "selected" : null)">
                                Chưa phản hồi
                            </option>

                            <!-- Đã phản hồi: status 2 & 4 -->
                            <option value="2"
                                    selected="@(currentStatus == 2 ? "selected" : null)">
                                Đã phản hồi
                            </option>
                        </select>
                    </div>

                    <!-- Khoảng thời gian -->
                    <div>
                        <label for="filter-time" class="block text-sm font-medium text-gray-700 mb-1">Khoảng thời gian</label>
                        <select id="filter-time" name="timeFilter"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                            <option value="30"
                                    selected="@(currentTime == "30" ? "selected" : null)">
                                30 ngày qua
                            </option>

                            <option value="60"
                                    selected="@(currentTime == "60" ? "selected" : null)">
                                60 ngày qua
                            </option>

                            <option value="all"
                                    selected="@(currentTime == "all" ? "selected" : null)">
                                Tất cả
                            </option>
                        </select>
                    </div>

                    <!-- Nút Lọc -->
                    <div class="flex justify-start md:justify-end">
                        <button type="submit"
                                class="w-full md:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <ion-icon name="filter-outline" class="mr-2"></ion-icon>
                            Lọc kết quả
                        </button>
                    </div>
                </form>


            </div>

            <!-- ===== Nội dung Khiếu nại Đã Gửi (BUYER) ===== -->
            <div>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                    <h2 class="text-lg font-semibold text-gray-800">
                        Danh sách khiếu nại đã gửi (@(Model?.Count ?? 0))
                    </h2>
                    <button type="button" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-blue-600 text-sm font-medium rounded-md shadow-sm text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <ion-icon name="add-circle-outline" class="mr-2"></ion-icon>
                        Gửi yêu cầu mới
                    </button>
                </div>

                <!-- Danh sách khiếu nại -->
                <div class="space-y-4">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            // Lấy sản phẩm đầu tiên để hiển thị chính
                            var firstProduct = item.Products?.FirstOrDefault();
                            var productTitle = firstProduct?.ProductTitle ?? "Sản phẩm";
                            var sellerName = firstProduct?.SellerName ?? item.SellerName ?? "Không rõ";

                            var otherCount = (item.Products?.Count ?? 0) - 1;
                            var extraText = otherCount > 0
                            ? $" + {otherCount} sản phẩm khác"
                            : string.Empty;

                            var submittedDate = item.SubmittedDate?.ToString("dd/MM/yyyy") ?? "-";

                            // Dùng Description làm "loại khiếu nại" nếu bạn chưa tách riêng field
                            var disputeType = string.IsNullOrWhiteSpace(item.Description)
                            ? "Khiếu nại"
                            : item.Description;

                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 transition hover:shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                                    <!-- Sản phẩm -->
                                    <div class="md:col-span-2 flex items-center space-x-3">
                                        <img src="https://placehold.co/80x80/e2e8f0/adb5bd?text=Hinh+SP"
                                        alt="Hình ảnh sản phẩm"
                                        class="w-16 h-16 rounded-md object-cover border" />
                                        <div>
                                            <p class="font-medium text-gray-900">
                                                @productTitle@if (!string.IsNullOrEmpty(extraText))
                                                {
                                                    <span class="text-sm text-gray-500">@extraText</span>
                                                }
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Mã ĐH: #@item.OrderId
                                            </p>
                                            
                                        </div>
                                    </div>

                                    <!-- Đối tác (Người bán) -->
                                    <div>
                                        <p class="text-xs text-gray-500">Người bán</p>
                                        <p class="font-medium text-gray-800">
                                            @sellerName
                                        </p>
                                    </div>

                                    <!-- Loại -->
                                    <div>
                                        <p class="text-xs text-gray-500">Loại</p>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            @disputeType
                                        </span>
                                    </div>

                                    <!-- Trạng thái & Ngày -->
                                    <div>
                                        <p class="text-xs text-gray-500">Trạng thái</p>
                                        @if(item.Status.Equals("1") || item.Status.Equals("3"))
                                        {
                                            <p class="font-semibold text-yellow-600">
                                                Chưa phản hồi
                                            </p>
                                        }
                                        else if (item.Status.Equals("2") || item.Status.Equals("4"))
                                        {
                                            <p class="font-semibold text-green-600">
                                                Đã phản hồi
                                            </p>
                                        }

                                        <p class="text-xs text-gray-500 mt-1">
                                            Ngày gửi: @submittedDate
                                        </p>
                                    </div>

                                    <!-- Hành động -->
                                    <div class="md:text-right">
                                        <button class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700">
                                            Xem chi tiết
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-sm text-gray-500">Bạn chưa có khiếu nại nào.</p>
                    }
                </div>
            </div>

        </div>
    </main>

</body>
</html>