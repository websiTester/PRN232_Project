@using Backend.DTOs.Dispute   <!-- đổi namespace cho đúng -->
@model List<DisputeListItemDto>

@{
    // Lấy lại giá trị filter từ query / ViewBag
    var currentStatus = Context.Request.Query["statusFilter"].ToString(); // "", "1", "2"
    var currentTime = Context.Request.Query["timeFilter"].ToString();   // "", "30", "60", "all"

    if (string.IsNullOrEmpty(currentTime))
    {
        currentTime = "all"; // mặc định
    }

    int sellerId = 0;
    if (ViewBag.sellerId is int sid)
    {
        sellerId = sid;
    }
    else if (Context.Request.RouteValues["sellerId"] != null)
    {
        int.TryParse(Context.Request.RouteValues["sellerId"]!.ToString(), out sellerId);
    }

    var totalCount = Model?.Count ?? 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khiếu nại Đã Nhận</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải icon (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    

    <!-- Nội dung chính -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Vùng nội dung -->
        <div class="bg-white p-6 rounded-lg shadow-sm">

            <!-- Bộ lọc -->
            <form method="get"
                  action="@Url.Action("SellerDispute", "Dispute", new { sellerId = sellerId })"
                  class="grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-4 mb-6 items-end">

                <!-- Trạng thái -->
                <div>
                    <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                    <select id="filter-status" name="statusFilter"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                        <option value=""
                                selected="@(string.IsNullOrEmpty(currentStatus) ? "selected" : "")">
                            Tất cả trạng thái
                        </option>

                        <!-- nhóm chưa phản hồi: Status 1 & 3 -->
                        <option value="1"
                                selected="@(currentStatus == "1" ? "selected" : "")">
                            Chưa phản hồi (1 &amp; 3)
                        </option>

                        <!-- nhóm đã phản hồi: Status 2 & 4 -->
                        <option value="2"
                                selected="@(currentStatus == "2" ? "selected" : "")">
                            Đã phản hồi (2 &amp; 4)
                        </option>
                    </select>
                </div>

                <!-- Khoảng thời gian -->
                <div>
                    <label for="filter-time" class="block text-sm font-medium text-gray-700 mb-1">Khoảng thời gian</label>
                    <select id="filter-time" name="timeFilter"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">

                        <option value="30"
                                selected="@(currentTime == "30" ? "selected" : "")">
                            30 ngày qua
                        </option>

                        <option value="60"
                                selected="@(currentTime == "60" ? "selected" : "")">
                            60 ngày qua
                        </option>

                        <option value="all"
                                selected="@(currentTime == "all" ? "selected" : "")">
                            Tất cả
                        </option>
                    </select>
                </div>

                <!-- Nút Lọc -->
                <div class="flex justify-start md:justify-end">
                    <button type="submit"
                            class="w-full md:w-auto inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <ion-icon name="filter-outline" class="mr-2"></ion-icon>
                        Lọc kết quả
                    </button>
                </div>
            </form>

            <!-- ===== Nội dung Khiếu nại Đã Nhận (SELLER) ===== -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        Danh sách khiếu nại đã nhận (@totalCount)
                    </h2>
                </div>

                <!-- Danh sách khiếu nại -->
                <div class="space-y-4">
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var item in Model)
                        {
                            var firstProduct = item.Products?.FirstOrDefault();
                            var productTitle = firstProduct?.ProductTitle ?? "Sản phẩm";
                            var otherCount = (item.Products?.Count ?? 0) - 1;
                            var extraText = otherCount > 0 ? $" + {otherCount} sản phẩm khác" : string.Empty;

                            var buyerName = !string.IsNullOrWhiteSpace(item.BuyerName)
                            ? item.BuyerName
                            : "Người mua";

                            var submittedDate = item.SubmittedDate?.ToString("dd/MM/yyyy") ?? "-";

                            // Map status code -> text cho seller
                            string statusText = item.Status switch
                            {
                                "1" => "CẦN HÀNH ĐỘNG CỦA BẠN",
                                "2" => "Đang chờ người mua",
                                "3" => "Chưa phản hồi (nhóm 1 & 3)",
                                "4" => "Đã đóng",
                                _ => "Không rõ"
                            };

                            bool needAction = item.Status == "1" || item.Status == "3";

                            string cardClass = needAction
                            ? "bg-red-50 border border-red-300"
                            : "bg-gray-50 border border-gray-200";

                            string statusClass = needAction
                            ? "font-semibold text-red-600"
                            : "font-semibold text-green-600";

                            <div class="@cardClass rounded-lg p-4 transition hover:shadow-md">
                                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                                    <!-- Sản phẩm -->
                                    <div class="md:col-span-2 flex items-center space-x-3">
                                        <img src="https://placehold.co/80x80/e2e8f0/adb5bd?text=Hinh+SP"
                                             alt="Hình ảnh sản phẩm"
                                             class="w-16 h-16 rounded-md object-cover border" />
                                        <div>
                                            <p class="font-medium text-gray-900">
                                                @productTitle@if (!string.IsNullOrEmpty(extraText))
                                                {
                                                    <span class="text-sm text-gray-500">@extraText</span>
                                                }
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Mã ĐH: #@item.OrderId
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Đối tác (Người mua) -->
                                    <div>
                                        <p class="text-xs text-gray-500">Người mua</p>
                                        <p class="font-medium text-gray-800">@buyerName</p>
                                    </div>

                                    <!-- Loại khiếu nại (dùng Description) -->
                                    <div>
                                        <p class="text-xs text-gray-500">Loại</p>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            @item.Description
                                        </span>
                                    </div>

                                    <!-- Trạng thái & Ngày -->
                                    <div>
                                        <p class="text-xs text-gray-500">Trạng thái</p>
                                        <p class="@statusClass">
                                            @statusText
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Ngày tạo: @submittedDate
                                        </p>
                                    </div>

                                    <!-- Hành động -->
                                    <div class="md:text-right">
                                        @if (needAction)
                                        {
                                            <button class="w-full md:w-auto px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700">
                                                Phản hồi ngay
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="w-full md:w-auto px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-700">
                                                Xem chi tiết
                                            </button>
                                        }

                                        <a href="#"
                                           class="block text-sm text-blue-600 hover:underline mt-2 text-center md:text-right">
                                            Xem chi tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-sm text-gray-500">Hiện bạn chưa có khiếu nại nào được gửi đến.</p>
                    }
                </div>
            </div>

        </div>
    </main>

</body>
</html>
